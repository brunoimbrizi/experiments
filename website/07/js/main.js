((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u={}.hasOwnProperty,v=function(a,b){function d(){this.constructor=a}for(var c in b)u.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},w=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(){}return a.IS_LOCAL=!1,a.GET_LINES="json/lines.json",a.GET_STATIONS="json/stations.json",a.GET_PREDICTION_SUMMARY="proxy/?line=$code",a.FALLBACK_PREDICTION_SUMMARY="xml/$code.xml",a.MAP_SIZE=5e5,a}(),f=function(){function a(){}return a.prototype.Bakerloo=!1,a.prototype.Central=!0,a.prototype.Circle=!1,a.prototype.District=!1,a.prototype.Hammersmith=!1,a.prototype.Jubilee=!1,a.prototype.Metropolitan=!1,a.prototype.Northern=!1,a.prototype.Piccadilly=!1,a.prototype.Victoria=!1,a.prototype.Waterloo=!1,a.prototype.speed=5,a.prototype.separate=!1,a.prototype.restart=null,a.prototype.mute=!1,a}(),d=function(){function b(){}return b.getSeconds=function(a){var b,c;return a.indexOf(":")<0?0:(b=a.split(":"),b.length===3?c=+b[0]*60*60+ +b[1]*60+ +b[2]:b.length===2?c=+b[0]*60+ +b[1]:c=+b[0],c)},b.mercatorEncode=function(b,c,d){var e,f,g,h;return d==null&&(d=0),b=+b,c=c*Math.PI/180,d||(d=a.MAP_SIZE),f=e=d,g=f*(180+b)/360%f,h=Math.log(Math.tan(c*.5+Math.PI*.25)),h=e*.5-f*h/(2*Math.PI),[g,h]},b.getTrainLocationValue=function(a){var b;return b=0,a.indexOf("Between")===0&&(b=.5),b},b.getTrainLastStation=function(a){var b,c,d,e;return b=/Between\s(.+)\sand\s/,c=b.exec(a),c&&(e=c[1]),e||(b=/(At|Approaching|Left|)\s(.+)/,c=b.exec(a),c&&(e=c[2])),e?(d=app.stations.findWhere({name:e}),d?d.get("code"):console.log("AppUtils.getTrainLastStation : stationName "+e+" not found.")):null},b}(),k=function(){function a(){}return a.map=function(a,b,c,d,e,f,g,h){var i,j;return f==null&&(f=!1),g==null&&(g=!0),h==null&&(h=!0),g&&a<b?d:h&&a>c?e:(i=(a-b)/(c-b),j=i*(e-d)+d,f?Math.round(j):j)},a.hexToRgb=function(a){var b,c,d,e,f;return e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a),e?(d=parseInt(e[1],16),c=parseInt(e[2],16),b=parseInt(e[3],16),f=d+", "+c+", "+b,{r:d,g:c,b:b,rgb:f}):null},a.rgbToHex=function(a,b,c){return"#"+((1<<24)+(a<<16)+(b<<8)+c).toString(16).slice(1)},a}(),q=function(){function a(){}return a.addLeadingZero=function(a,b){var c,d,e;b==null&&(b=1),d=String(a);for(c=e=0;0<=b?e<b:e>b;c=0<=b?++e:--e)a<Math.pow(10,c+1)&&a>-1&&(d="0"+d);return d},a}(),i=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return v(c,b),c.prototype.defaults={code:null,name:null,color:null,branches:null,trains:null,date:null},c.prototype.idAttribute="code",c.prototype.gettingPrediction=null,c.prototype.getPredictionSummary=function(b){var c=this;return b==null&&(b=!1),this.gettingPrediction=!0,this.url=a.GET_PREDICTION_SUMMARY.replace("$code",this.get("code")),b&&(this.url=a.FALLBACK_PREDICTION_SUMMARY.replace("$code",this.get("code"))),this.fetch({dataType:"xml",success:function(a,b){return console.log("LineModel.getPredictionSummary success"),c.trigger("loaded",c.get("code"))},error:function(a,b){return console.log("LineModel.getPredictionSummary error"),c.getPredictionSummary(!0)}})},c.prototype.parse=function(a){var b,c,e=this;return this.gettingPrediction?(b={},b.trains=new r,$(a).children().children().each(function(a,c){var e,f,g,h,i;c.nodeName==="Time"&&(i=$(c).attr("TimeStamp"),h=i.substr(i.indexOf(" ")+1),e=new Date,e.setHours(h.substr(0,2)),e.setMinutes(h.substr(3,2)),e.setSeconds(h.substr(6,2)),b.date=e);if(c.nodeName==="S")return f=$(c).attr("Code"),g=$(c).attr("N"),$(c).children().each(function(a,c){var e;return e=$(c).attr("N"),$(c).children().each(function(a,c){var g,h,i,j,k,l,o,p,q,r,t;g=$(c),q=g.attr("S"),r=g.attr("T"),l=g.attr("D"),k=g.attr("C"),p=g.attr("L"),o=g.attr("DE");if(r!=="0"){t=b.trains.get(q);if(!t||t.get("destination")!==o)t=new s,t.set("id",q),t.set("trip",r),t.set("location",p),t.set("destination",o),t.set("direction",e),t.set("schedule",new m),b.trains.push(t);i=t.get("schedule"),j=app.stations.get(f);if(j&&!i.get(f))return h=new n,h.set("station",f),h.set("time",d.getSeconds(k)),i.push(h)}})})}),c=[],b.trains.each(function(a){var b;return b=a.get("schedule"),b.length<=1&&c.push(a),b.sort()}),b.trains.remove(c),b):a},c}(Backbone.Model),l=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.defaults={name:null,number:null,direction:null,lines:null,station:null,location:null},b}(Backbone.Model),n=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.defaults={station:null,time:null},b.prototype.idAttribute="station",b}(Backbone.Model),p=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.defaults={code:null,name:null,number:null,lines:null,platforms:null,location:null,position:null},b.prototype.idAttribute="code",b}(Backbone.Model),s=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.defaults={id:null,trip:null,destination:null,location:null,direction:null,schedule:null},b}(Backbone.Model),h=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.model=i,b}(Backbone.Collection),m=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.model=n,b.prototype.comparator=function(a){return a.get("time")},b}(Backbone.Collection),o=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.model=p,b}(Backbone.Collection),r=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return v(b,a),b.prototype.model=s,b}(Backbone.Collection),b=function(){function a(){this.view=app.view,this.mouse={x:0,y:0},this.hw=this.view.sketch.width*.5,this.hh=this.view.sketch.height*.5,this.initThree(),this.initLines(),this.initInteractiveObjects()}return a.prototype.view=null,a.prototype.camera=null,a.prototype.scene=null,a.prototype.renderer=null,a.prototype.projector=null,a.prototype.controls=null,a.prototype.container=null,a.prototype.mouse=null,a.prototype.interactiveObjects=null,a.prototype.selectedMatrix=null,a.prototype.selectedOffset=null,a.prototype.intersected=null,a.prototype.lines=null,a.prototype.initThree=function(){var a,b;return this.scene=new THREE.Scene,this.scene.fog=new THREE.Fog(2302755,1,2e3),b=new THREE.DirectionalLight(6710886),b.position.set(0,2,1),this.scene.add(b),a=new THREE.AmbientLight(1118481),this.scene.add(a),this.renderer=new THREE.WebGLRenderer({canvas:this.view.sketch.canvas}),this.renderer.setSize(this.view.sketch.width,this.view.sketch.height),this.projector=new THREE.Projector,this.camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.01,2e3),this.camera.position=new THREE.Vector3(-57,-82,12),this.camera.up=new THREE.Vector3(.18,0,.98),this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement),this.controls.target.set(0,0,0),this.controls.rotateSpeed=1,this.controls.zoomSpeed=.8,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!1,this.controls.dynamicDampingFactor=.15,this.controls.maxDistance=3e3,this.container=new THREE.Object3D,this.scene.add(this.container)},a.prototype.initLines=function(){var a,b,c,d,e,f;this.lines=[],e=app.lines.models,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],a=new j(new THREE.Object3D,b,this.lines.length),this.container.add(a.container),f.push(this.lines.push(a));return f},a.prototype.initInteractiveObjects=function(){var a,b,c,d,e,f;this.interactiveObjects=[],e=this.lines,f=[];for(c=0,d=e.length;c<d;c++)a=e[c],f.push(function(){var c,d,e,f;e=a.stations,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(this.interactiveObjects.push(b));return f}.call(this));return f},a.prototype.update=function(){var a,b,c;if(!this.renderer)return;this.controls.update();if(this.selectedMatrix)return a=this.selectedMatrix,this.selectedOffset&&(a=(new THREE.Matrix4).copy(this.selectedMatrix),a.elements[14]+=this.selectedOffset),c=this.projector.projectVector((new THREE.Vector3).getPositionFromMatrix(a),this.camera),c.x=c.x*this.hw+this.hw,c.y=-(c.y*this.hh)+this.hh,b=-5,this.view.ui.label.pos.x=floor(c.x),this.view.ui.label.pos.y=floor(c.y)+b},a.prototype.draw=function(){if(!this.renderer)return;return this.renderer.render(this.scene,this.camera)},a.prototype.resize=function(){if(!this.renderer)return;return this.camera.aspect=this.view.sketch.width/this.view.sketch.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.view.sketch.width,this.view.sketch.height),this.hw=this.view.sketch.width*.5,this.hh=this.view.sketch.height*.5},a.prototype.mousedown=function(a){var b,c,d,e,f,g,h;a.preventDefault(),this.controls.enabled=!0,f=new THREE.Vector3(this.mouse.x,this.mouse.y,.5),this.projector.unprojectVector(f,this.camera),d=new THREE.Raycaster(this.camera.position,f.sub(this.camera.position).normalize()),c=d.intersectObjects(this.interactiveObjects);if(c.length>0){for(g=0,h=c.length;g<h;g++){b=c[g],e=b.object;if(this.lines[e.lineIndex].enabled)break}if(!this.lines[e.lineIndex].enabled)return;return this.controls.enabled=!1,this.view.ui.toggleLabel(e)}},a.prototype.mousemove=function(a){return this.mouse.x=a.clientX/window.innerWidth*2-1,this.mouse.y=-(a.clientY/window.innerHeight)*2+1},a.prototype.mouseup=function(a){return a.preventDefault(),this.controls.enabled=!0},a}(),c=function(){function a(){this.onMuteChange=w(this.onMuteChange,this),this.onSeparateChange=w(this.onSeparateChange,this),this.onRestartClick=w(this.onRestartClick,this),this.updateClock=w(this.updateClock,this),this.view=app.view,this.initGUI(),this.initLabel()}return a.prototype.view=null,a.prototype.guiData=null,a.prototype.labelCanvas=null,a.prototype.label=null,a.prototype.clock=null,a.prototype.clockCount=null,a.prototype.clockTimeout=null,a.prototype.initLabel=function(){var a;return this.labelCanvas=document.getElementById("canvasLabel"),this.labelCanvas.width=this.view.sketch.width,this.labelCanvas.height=this.view.sketch.height,a=this.labelCanvas.getContext("2d"),this.label=new g(a)},a.prototype.initClock=function(){if(this.clock)return;return this.clock=document.getElementById("clock"),this.clockCount=0,this.updateClock()},a.prototype.initGUI=function(){var a,b,c,d,e,g,h,i,j;e=new dat.GUI,this.guiData=new f,b=e.addFolder("Lines"),b.open(),b.add(this.guiData,"Bakerloo"),b.add(this.guiData,"Central"),b.add(this.guiData,"District"),b.add(this.guiData,"Hammersmith"),b.add(this.guiData,"Jubilee"),b.add(this.guiData,"Metropolitan"),b.add(this.guiData,"Northern"),b.add(this.guiData,"Piccadilly"),b.add(this.guiData,"Victoria"),g=this,j=b.__controllers;for(h=0,i=j.length;h<i;h++)a=j[h],a.onChange(function(){return g.onLineChange(this)}),this.onLineChange(a);return c=e.addFolder("Trains"),this.guiData.restart=this.onRestartClick,c.add(this.guiData,"speed",1,50).step(1).onFinishChange(function(){return g.onSpeedChange()}),c.add(this.guiData,"restart"),d=e.addFolder("Sound"),d.add(this.guiData,"mute").onChange(function(){return g.onMuteChange()})},a.prototype.updateClock=function(){var a;a=new Date(this.view.lines[0].model.get("date").getTime()),a.setMinutes(a.getMinutes()+this.clockCount),this.clock.innerHTML=q.addLeadingZero(a.getHours())+":"+q.addLeadingZero(a.getMinutes()),this.clockCount++,clearTimeout(this.clockTimeout);if(this.clockCount>30)return;return this.clockTimeout=setTimeout(this.updateClock,6e4/this.guiData.speed)},a.prototype.toggleLabel=function(a){return this.view.three.selectedMatrix=(new THREE.Matrix4).copy(a.matrixWorld),this.view.three.selectedOffset=0,this.label.showed&&this.label.label===a.name.toUpperCase()&&this.label.lineIndex===a.lineIndex?this.label.hide(!1):this.label.show(a.code,a.name,"rgb("+a.color+")",a.lineIndex)},a.prototype.update=function(){},a.prototype.draw=function(){return this.label.ctx.clearRect(0,0,this.view.sketch.width,this.view.sketch.height),this.label.draw()},a.prototype.resize=function(){return this.labelCanvas.width=this.view.sketch.width,this.labelCanvas.height=this.view.sketch.height},a.prototype.keyup=function(a){var b,c,d,e,f,g;if(!this.label.showed)return;if(a.keyCode!==39&&a.keyCode!==37)return;d=this.view.lines[this.label.lineIndex],c=d.getFirstBranchIndex(this.label.code),g=d.getStationIndexInBranch(this.label.code,c),b=d.branches[c];if(a.keyCode===39){if(g<b.length-1)return e=b[g+1],f=d.getSprite(e),this.toggleLabel(f)}else if(a.keyCode===37&&g>0)return e=b[g-1],f=d.getSprite(e),this.toggleLabel(f)},a.prototype.onLineChange=function(a){var b,c,d,e,f;f=this.view.lines;for(d=0,e=f.length;d<e;d++){c=f[d];if(c.model.get("code")===a.property.substring(0,1))break}b=a.object[a.property],b&&!c.enabled?c.enable():!b&&c.enabled&&c.disable();if(this.label&&this.label.lineIndex!==null&&!this.view.lines[this.label.lineIndex].enabled)return this.label.hide()},a.prototype.onSpeedChange=function(){var a,b,c,d,e,f,g,h;g=this.view.lines;for(c=0,e=g.length;c<e;c++){a=g[c];if(a&&a.timelines){h=a.timelines;for(d=0,f=h.length;d<f;d++)b=h[d],b.timeScale(this.guiData.speed)}}return this.clockCount--,this.updateClock()},a.prototype.onRestartClick=function(){var a,b,c,d,e,f,g,h;g=this.view.lines;for(c=0,e=g.length;c<e;c++){a=g[c];if(a&&a.timelines){h=a.timelines;for(d=0,f=h.length;d<f;d++)b=h[d],b.restart()}}return this.clockCount=0,this.updateClock()},a.prototype.onSeparateChange=function(){var a,b,c,d,e,f,g,h,i,j,k=this;a=0;if(this.guiData.separate){g=this.view.lines,i=[];for(c=0,e=g.length;c<e;c++)b=g[c],this.selectedOffset&&this.label.showed&&this.label.lineIndex===b.index&&(a=-this.selectedOffset),i.push(TweenLite.to(b.container.position,1,{z:200-50*b.index,ease:Quart.easeInOut,onUpdateParams:[b],onUpdate:function(b){if(k.label.showed&&k.label.lineIndex===b.index)return k.selectedOffset=b.container.position.z-a}}));return i}h=this.view.lines,j=[];for(d=0,f=h.length;d<f;d++)b=h[d],!this.selectedOffset&&this.label.showed&&this.label.lineIndex===b.index&&(a=b.container.position.z),j.push(TweenLite.to(b.container.position,1,{z:0,ease:Quart.easeInOut,onUpdateParams:[b],onUpdate:function(b){if(k.label&&k.label.lineIndex===b.index)return k.selectedOffset=b.container.position.z-a}}));return j},a.prototype.onMuteChange=function(){return this.view.audio.muted=this.guiData.mute},a}(),e=function(a){function d(){return this.show=w(this.show,this),this.initAudio=w(this.initAudio,this),this.initUI=w(this.initUI,this),this.initThree=w(this.initThree,this),d.__super__.constructor.apply(this,arguments)}return v(d,a),d.prototype.sketch=null,d.prototype.three=null,d.prototype.ui=null,d.prototype.showed=null,d.prototype.lines=null,d.prototype.audio=null,d.prototype.el="#container",d.prototype.init=function(){return this.initSketch(),this.initThree(),this.initUI(),this.initAudio()},d.prototype.initSketch=function(){var a=this;return this.sketch=Sketch.create({container:document.getElementById("container"),type:Sketch.WEB_GL,setup:function(){},update:function(){return a.three.update(),a.ui.update()},draw:function(){return a.three.draw(),a.ui.draw()},resize:function(){if(!a.three)return;return a.three.resize(),a.ui.resize()},mousedown:function(b){return a.showed||(TweenLite.killTweensOf(a.three.camera.position),TweenLite.killTweensOf(a.three.camera.up),a.showed=!0),a.three.mousedown(b)},mousemove:function(b){return a.three.mousemove(b)},mouseup:function(b){return a.three.mouseup(b)},keyup:function(b){return a.ui.keyup(b)}})},d.prototype.initThree=function(){return this.three=new b,this.lines=this.three.lines},d.prototype.initUI=function(){return this.ui=new c},d.prototype.initAudio=function(){return this.audio=document.getElementById("audio")},d.prototype.show=function(a){var b;return a==null&&(a=0),this.audio.muted=!1,this.audio.volume=0,b={volume:0},TweenLite.to(this.audio,3,{volume:.4,delay:a+2,ease:Linear.easeNone})},d}(Backbone.View),g=function(){function a(a){var b=this;this.ctx=a,this.box={x:0,y:0,w:0,h:0},this.arw={x:0,y:0,w:0,h:0},this.txt={x:0,y:0,w:0,h:0},this.img={x:0,y:0,w:0,h:0},this.pos={x:100,y:100},this.badge=new Image,this.badge.onload=function(){return b.img.w=b.badge.width},this.badge.src="img/badges.png",this.arw.w=this.ARW_WIDTH,this.arw.h=this.ARW_HEIGHT,this.color="#666"}return a.prototype.ctx=null,a.prototype.code=null,a.prototype.label=null,a.prototype.badge=null,a.prototype.lineIndex=null,a.prototype.color=null,a.prototype.box=null,a.prototype.arw=null,a.prototype.img=null,a.prototype.txt=null,a.prototype.pos=null,a.prototype.showed=!1,a.prototype.BOX_HEIGHT=34,a.prototype.ARW_WIDTH=20,a.prototype.ARW_HEIGHT=10,a.prototype.IMG_WIDTH=20,a.prototype.IMG_HEIGHT=18,a.prototype.draw=function(){var a,b,c,d,e,f,g,h;if(!this.showed)return;return c=this.box.x+this.pos.x,d=this.box.y+this.pos.y,a=this.arw.x+this.pos.x,b=this.arw.y+this.pos.y,e=this.img.x+this.pos.x,f=this.img.y+this.pos.y,g=this.txt.x+this.pos.x,h=this.txt.y+this.pos.y,this.ctx.beginPath(),this.ctx.moveTo(c,d),this.ctx.lineTo(c,d+this.box.h),this.ctx.lineTo(a,d+this.box.h),this.ctx.lineTo(a+this.arw.w*.5,b+this.arw.h),this.ctx.lineTo(a+this.arw.w,d+this.box.h),this.ctx.lineTo(c+this.box.w,d+this.box.h),this.ctx.lineTo(c+this.box.w,d),this.ctx.lineTo(c,d),this.ctx.strokeStyle=this.color,this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.stroke(),this.ctx.fill(),this.ctx.closePath(),this.ctx.globalCompositeOperation="source-atop",this.ctx.drawImage(this.badge,0,this.IMG_HEIGHT*this.lineIndex,this.IMG_WIDTH,this.IMG_HEIGHT,e,f,this.IMG_WIDTH,this.IMG_HEIGHT),this.ctx.fillStyle=this.color,this.ctx.font="12px Monda",this.ctx.fillText(this.label,g,h),this.ctx.globalCompositeOperation="source-over"},a.prototype.show=function(a,b,c,d){var e,f,g,h,i,j,k=this;return this.code=a,this.label=b,this.color=c,this.lineIndex=d,this.showed=!0,this.label=this.label.toUpperCase(),this.ctx.font="12px Monda",this.txt.w=this.ctx.measureText(this.label).width,this.box.x=this.box.y=0,this.box.w=this.box.h=0,h=this.txt.w+60,g=this.BOX_HEIGHT,i=this.box.x-h*.5,j=this.box.y-g-this.ARW_HEIGHT*2,TweenLite.to(this.box,.4,{x:i,w:h}),TweenLite.to(this.box,.4,{y:j,h:g,ease:Quart.easeInOut,onUpdate:function(){return k.arw.y=k.box.y+k.box.h}}),f=this.ARW_WIDTH,e=this.ARW_HEIGHT,this.arw.x=this.box.x-f*.5,this.arw.y=this.box.y-this.box.h,this.arw.h=0,TweenLite.to(this.arw,.3,{h:e,ease:Quart.easeOut,delay:.2}),this.img.x=i+14,this.img.y=this.box.y+50,TweenLite.to(this.img,.4,{y:j+8,ease:Expo.easeOut,delay:.2}),this.txt.x=this.img.x+this.img.w+9,this.txt.y=this.box.y+100,TweenLite.to(this.txt,.4,{y:j+21,ease:Expo.easeOut,delay:.1})},a.prototype.hide=function(a){var b,c,d,e,f=this;a==null&&(a=!0);if(a){this.showed=!1;return}return c=this.box.w*.9,b=this.BOX_HEIGHT,d=this.box.x+(this.box.w-c)*.5,e=this.box.y+10,TweenLite.to(this.box,.2,{x:d,w:c,y:e,h:2,ease:Expo.easeIn,onUpdate:function(){return f.arw.y=f.box.y+f.box.h,f.arw.h-=.5},onComplete:function(){return f.showed=!1}})},a}(),j=function(){function a(a,b,c){this.container=a,this.model=b,this.index=c,this.initStations(),this.initTube(),this.initSplineTs()}return a.prototype.container=null,a.prototype.branches=null,a.prototype.splines=null,a.prototype.splineCurves=null,a.prototype.splineTs=null,a.prototype.stations=null,a.prototype.trains=null,a.prototype.tubes=null,a.prototype.timelines=null,a.prototype.model=null,a.prototype.color=null,a.prototype.index=null,a.prototype.enabled=!0,a.prototype.initStations=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;k=app.stations.get("KXX"),w=d.mercatorEncode(k.get("lon"),k.get("lat")),c=w[0],e=w[1],this.color=parseInt(this.model.get("color"))||16777215,this.branches=this.model.get("branches"),this.stations=[],this.splineCurves=[],this.splines=[];if(!this.branches)return;m=new THREE.SphereGeometry(1.5,5,5),n=new THREE.MeshBasicMaterial({color:this.color}),r=THREE.ImageUtils.loadTexture("img/flat.png"),q=new THREE.SpriteMaterial({map:r,useScreenCoordinates:!1,color:this.color}),u=[],B=this.branches,C=[];for(z=0,A=B.length;z<A;z++)a=B[z],o=[],this.splines.push(o),C.push(function(){var m,r,z,A,B;B=[];for(m=0,z=a.length;m<z;m++){t=a[m],k=app.stations.get(t);if(!k)continue;b=this.model.get("code"),f=k.get("depth"),i=3,w=d.mercatorEncode(k.get("lon"),k.get("lat")),v=w[0]-c,x=w[1]-e,y=f[b],b==="X"&&(y||(y=f.D),y||(y=f.H),y||(y=f.M));for(h in f){if(h===b)continue;g=y-f[h],Math.abs(g)<i&&(g>0?y+=i-g:y-=i+g)}f[b]=y,j=new THREE.Vector3(v,-x,y-100),k.set("position",j),o.push(j),l=!1;for(r=0,A=u.length;r<A;r++){s=u[r];if(t===s){l=!0;break}}if(l)continue;u.push(t),p=new THREE.Sprite(q),p.position=j,p.scale.set(4,4,1),p.code=k.get("code"),p.name=k.get("name"),p.color=(n.color.r*255|0)+", "+(n.color.g*255|0)+", "+(n.color.b*255|0),this.model.get("code")==="N"&&(p.color="80, 80, 80"),p.lineIndex=this.index,this.stations.push(p),B.push(this.container.add(p))}return B}.call(this));return C},a.prototype.initTube=function(){var a,b,c,d,e,f,g,h,i;this.tubes=[],h=this.splines,i=[];for(f=0,g=h.length;f<g;f++)a=h[f],b=new THREE.SplineCurve3(a),this.splineCurves.push(b),d=new THREE.TubeGeometry(b,a.length*8,1.5,4),e=new THREE.LineBasicMaterial({color:this.color,opacity:.5,transparent:!0,linewidth:1}),this.model.get("code")==="N"&&(e=new THREE.LineBasicMaterial({color:this.color,transparent:!0,linewidth:1})),this.reorderVertices(d),c=new THREE.Line(d,e,THREE.LineStrip),this.container.add(c),i.push(this.tubes.push(c));return i},a.prototype.initSplineTs=function(){var a,b,c,d,e,f,g,h;this.splineTs=[];if(!this.branches)return;h=[];for(b=f=0,g=this.branches.length;0<=g?f<g:f>g;b=0<=g?++f:--f)a=this.branches[b],d=this.splineCurves[b],c={},this.splineTs[b]=c,h.push(function(){var b,f,g;g=[];for(b=0,f=a.length;b<f;b++)e=a[b],g.push(c[e]=this.getSplineT(d,app.stations.get(e).get("position")));return g}.call(this));return h},a.prototype.initTrains=function(){var a,b,c,e,f,g,h=this;this.trains=[],this.timelines=[],b=this.model.get("trains"),b.each(function(a,b,c){var e,f,g;g=new t(h.container,a,h.color),h.trains.push(g),f=new TimelineLite,f.timeScale(app.view.ui.guiData.speed),h.timelines.push(f),g.t=-1,e=a.get("schedule"),e.each(function(a,b,c){var e,i,j,k,l,m,n,o,p,q;i=a,m=b<c.length-1?c[b+1]:a,j=i.get("station"),n=m.get("station"),e=h.getBranchIndex(j,n);if(e!==-1)return p=h.splineCurves[e],k=h.splineTs[e][j],o=h.splineTs[e][n],b===0&&(l=g.model.get("location"),q=d.getTrainLocationValue(l),q&&(k+=(o-k)*q)),f.to(g,.01,{t:k,onUpdate:h.onTrainUpdate,onUpdateParams:[g,p]}),f.to(g,m.get("time")-f._totalDuration,{t:o,ease:Linear.easeNone,onUpdate:h.onTrainUpdate,onUpdateParams:[g,p]})});if(!f._totalDuration)return g.hide(),h.trains.pop()}),f=this.trains,g=[];for(c=0,e=f.length;c<e;c++)a=f[c],this.enabled?g.push(void 0):g.push(a.hide());return g},a.prototype.onTrainUpdate=function(a,b){var c,d,e,f,g;return a.train.position=b.getPoint(a.t),f=b.getTangent(a.t).normalize(),g=new THREE.Vector3(0,1,0),d=(new THREE.Vector3).crossVectors(g,f).normalize(),c=Math.acos(g.dot(f)),e=new THREE.Matrix4,e.makeRotationAxis(d,c),a.train.rotation.setEulerFromRotationMatrix(e)},a.prototype.getStationIndexInBranch=function(a,b){var c,d,e,f,g;c=this.branches[b];for(d=f=0,g=c.length;0<=g?f<g:f>g;d=0<=g?++f:--f){e=c[d];if(a===e)return d}return-1},a.prototype.getSplineT=function(a,b,c,d){var e,f,g,h,i,j;c==null&&(c=0),d==null&&(d=1),i=a.getPoint(c),j=a.getPoint(d),f=b.distanceToSquared(i),g=b.distanceToSquared(j),e=0;while(Math.min(f,g)>1){h=e>5?.5:.25,f>g?c+=(d-c)*h:d-=(d-c)*h,i=a.getPoint(c),j=a.getPoint(d),f=b.distanceToSquared(i),g=b.distanceToSquared(j);if(e>15)break;e++}return f<g?c:d},a.prototype.getBranchIndex=function(a,b){var c,d,e,f,g,h,i,j,k;d=-1,e=-1;for(f=h=0,k=this.branches.length;0<=k?h<k:h>k;f=0<=k?++h:--h){c=this.branches[f];for(i=0,j=c.length;i<j;i++){g=c[i],g===a&&(d=f),g===b&&(e=f);if(d>-1&&d===e)return d}}return-1},a.prototype.getFirstBranchIndex=function(a){var b,c,d,e,f,g,h;for(c=e=0,h=this.branches.length;0<=h?e<h:e>h;c=0<=h?++e:--e){b=this.branches[c];for(f=0,g=b.length;f<g;f++){d=b[f];if(d===a)return c}}return-1},a.prototype.getSprite=function(a){var b,c,d,e;e=this.stations;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.code===a)return b}return null},a.prototype.reorderVertices=function(a){var b,c,d,e,f,g,h,i,j,k,l;h=a.vertices,f=a.radiusSegments,c=h.length,d=[];for(e=i=0;0<=f?i<f:i>f;e=0<=f?++i:--i){g=[];if(e%2)for(b=j=l=c+e-f;l<=0?j<0:j>0;b=j+=-f)g.push(h[b]);else for(b=k=e;e<=c?k<c:k>c;b=k+=f)g.push(h[b]);d=d.concat(g)}return a.vertices=d},a.prototype.enable=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;this.enabled=!0,a=new THREE.Color(this.color),k=this.tubes;for(e=0,h=k.length;e<h;e++)d=k[e],d.material.color=a,this.color===256&&(d.material.opacity=1);l=this.stations;for(f=0,i=l.length;f<i;f++)b=l[f],b.material.color=a,b.material.opacity=1;if(!this.trains)return null;m=this.trains;for(g=0,j=m.length;g<j;g++)c=m[g],c.show();return null},a.prototype.disable=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;this.enabled=!1,a=new THREE.Color(4473924),k=this.tubes;for(e=0,h=k.length;e<h;e++)d=k[e],d.material.color=a,d.material.opacity=.5;l=this.stations;for(f=0,i=l.length;f<i;f++)b=l[f],b.material.color=a,b.material.opacity=.3;if(!this.trains)return null;m=this.trains;for(g=0,j=m.length;g<j;g++)c=m[g],c.hide();return null},a}(),t=function(){function a(a,b,c){this.container=a,this.model=b,this.color=c,this.initTrain()}return a.prototype.container=null,a.prototype.train=null,a.prototype.model=null,a.prototype.color=null,a.prototype.t=null,a.prototype.initTrain=function(){var a,b,c,d;return c=new THREE.CubeGeometry(1,3,1),d=new THREE.MeshBasicMaterial({color:this.color}),a=this.model.get("schedule"),b=a.at(0).get("station"),this.train=new THREE.Mesh(c,d),this.container.add(this.train)},a.prototype.show=function(){return this.train.visible=!0},a.prototype.hide=function(){return this.train.visible=!1},a}(),window.app={view:null,lines:null,stations:null,init:function(){if(!Detector.webgl){Detector.addGetWebGLMessage();return}return app.initLines(),app.initStations()},initLines:function(){var b=this;return app.lines=new h,app.lines.url=a.GET_LINES,app.lines.fetch({success:function(a,b){return console.log("app.lines.fetch success"),app.initWithData()},error:function(a,b){return console.log("app.lines.fetch error")}})},initStations:function(){var b=this;return app.stations=new o,app.stations.url=a.GET_STATIONS,app.stations.fetch({success:function(a,b){return console.log("app.stations.fetch success"),app.initWithData()},error:function(a,b){return console.log("app.stations.fetch error")}})},initWithData:function(){if(!app.lines.length)return;if(!app.stations.length)return;return app.initPredictionSummary(),app.initView()},initPredictionSummary:function(){return app.lines.each(function(a,b,c){if(a.get("code")!=="X")return a.once("loaded",app.onPredictionSummaryLoaded),a.getPredictionSummary()})},initView:function(){return app.view=new e,app.view.init()},onPredictionSummaryLoaded:function(a){var b,c,d,e;e=app.view.lines;for(c=0,d=e.length;c<d;c++)b=e[c],b.model.get("code")===a&&b.initTrains();a==="B"&&app.view.ui.initClock();if(a==="C")return app.view.show(1)}},app.init()})).call(this)